name: HidenCloudè‡ªåŠ¨ç»­æœŸ

on:
  # å®šæ—¶è¿è¡Œ - æ¯å¤©ä¸Šåˆ9ç‚¹ï¼ˆUTCæ—¶é—´1ç‚¹ï¼‰
  schedule:
    - cron: '0 1 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  auto-renewal:
    runs-on: ubuntu-latest
    
    # æˆäºˆå·¥ä½œæµå†™å…¥ä»“åº“å†…å®¹å’Œç®¡ç†Actionsçš„æƒé™
    permissions:
      contents: write
      actions: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install playwright>=1.40.0 python-dotenv>=1.0.0
        # å®‰è£… Playwright æµè§ˆå™¨
        playwright install chromium
        # å®‰è£…ç³»ç»Ÿä¾èµ–
        playwright install-deps chromium
    
    - name: Run auto login script
      env:
        REMEMBER_WEB_COOKIE: ${{ secrets.REMEMBER_WEB_COOKIE }}
        HIDENCLOUD_SERVERS: ${{ secrets.HIDENCLOUD_SERVERS }}
        HIDENCLOUD_ACCOUNT: ${{ secrets.HIDENCLOUD_ACCOUNT }}
      run: |
        python main.py
    
    - name: Upload screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: screenshots-${{ github.run_id }}
        path: "*.png"
        retention-days: 3
    
    - name: Commit and push README.md
      if: always()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md
        git diff --staged --quiet || git commit -m "Update README.md with latest run results [$(date +'%Y-%m-%d %H:%M:%S')]"
        git push
    
    - name: Send Telegram notification
      if: always() && env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != ''
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        # æå–README.mdä¸­çš„å…³é”®ä¿¡æ¯
        if [ -f "README.md" ]; then
          # æå–æœåŠ¡å™¨ID
          SERVER_ID=$(grep "ğŸ–¥ï¸æœåŠ¡å™¨IDï¼š" README.md | sed 's/.*ğŸ–¥ï¸æœåŠ¡å™¨IDï¼š`\([^`]*\)`.*/\1/')
          # æå–ç»­æœŸç»“æœ
          RENEWAL_STATUS=$(grep "ğŸ“Šç»­æœŸç»“æœï¼š" README.md | sed 's/.*ğŸ“Šç»­æœŸç»“æœï¼š\([^<]*\).*/\1/')
          # æå–æ—§åˆ°æœŸæ—¶é—´
          OLD_DATE=$(grep "ğŸ•›ï¸æ—§åˆ°æœŸæ—¶é—´:" README.md | sed 's/.*ğŸ•›ï¸æ—§åˆ°æœŸæ—¶é—´: `\([^`]*\)`.*/\1/')
          # æå–æ–°åˆ°æœŸæ—¶é—´ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          NEW_DATE=$(grep "ğŸ•¡ï¸æ–°åˆ°æœŸæ—¶é—´ï¼š" README.md | sed 's/.*ğŸ•¡ï¸æ–°åˆ°æœŸæ—¶é—´ï¼š`\([^`]*\)`.*/\1/' || echo "")
        else
          SERVER_ID="Unknown"
          RENEWAL_STATUS="âŒFailed"
          OLD_DATE="N/A"
          NEW_DATE=""
        fi
        
        # æ„å»ºé€šçŸ¥æ¶ˆæ¯
        MESSAGE="â˜ï¸HidenCloudç»­æœŸé€šçŸ¥
        ğŸ“…æ‰§è¡Œæ—¶é—´ï¼š$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"
        
        ğŸ–¥ï¸æœåŠ¡å™¨IDï¼š${SERVER_ID}
        ğŸ“Šç»­æœŸç»“æœï¼š${RENEWAL_STATUS}
        ğŸ•›ï¸æ—§åˆ°æœŸæ—¶é—´: ${OLD_DATE}"
        
        # å¦‚æœæœ‰æ–°åˆ°æœŸæ—¶é—´ï¼Œæ·»åŠ åˆ°æ¶ˆæ¯ä¸­
        if [ ! -z "$NEW_DATE" ]; then
          MESSAGE="${MESSAGE}
        ğŸ•¡ï¸æ–°åˆ°æœŸæ—¶é—´ï¼š${NEW_DATE}"
        fi
        
        MESSAGE="${MESSAGE}
        
        ğŸ“‹ è¯¦ç»†ä¿¡æ¯ï¼š
        ğŸ”— [æŸ¥çœ‹è¿è¡Œæ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        ğŸ“¸ [ä¸‹è½½æˆªå›¾](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)"
        
        # å‘é€Telegramæ¶ˆæ¯
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d chat_id="${TELEGRAM_CHAT_ID}" \
          -d text="${MESSAGE}" \
          -d parse_mode="Markdown"
    
    - name: Telegramé€šçŸ¥è·³è¿‡æç¤º
      if: always() && (env.TELEGRAM_BOT_TOKEN == '' || env.TELEGRAM_CHAT_ID == '')
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: echo "æœªé…ç½®Telegramå˜é‡ï¼Œè·³è¿‡é€šçŸ¥"

    - name: Delete old workflow runs
      uses: MajorScruffy/delete-old-workflow-runs@v0.3.0
      env:
        GITHUB_TOKEN: ${{ github.token }}
      with:
        repository: ${{ github.repository }}
        older-than-seconds: 172800  # åˆ é™¤2å¤©å‰çš„è®°å½•
